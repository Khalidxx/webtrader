{"version":3,"sources":["../../../../src/viewtransaction/viewTransaction.es6"],"names":["ChartSettings","require","open_dialogs","NOTE_TEXT","EXPIRED","i18n","MARKET_RATE","NO_RESALE","FINISHED","market_data_disruption_win","showMarketDataDisruptionWindow","moveToTop","market_disrupt_msg","root","windows","createBlankWindow","title","height","resizable","collapsable","minimizable","maximizable","destroy","dialog","remove","window","dd","countDecimals","value","toString","split","length","initChart","state","options","data","type","display_decimals","history","times","prices","i","push","Math","max","substring","indexOf","candles","map","c","epoch","open","high","low","close","el","find","CHART_LABELS","getChartLabels","proposal_open_contract","entry_tick_time","date_start","zone_start","chart_options","credits","href","text","chart","renderTo","backgroundColor","width","marginLeft","marginRight","subtitle","getLabelEl","useHTML","tooltip","formatter","spot","addComma","y","spot_time","moment","utc","x","format","series","name","xAxis","categories","startOnTick","endOnTick","min","labels","overflow","yAxis","align","zIndex","zoneAxis","zones","color","exporting","enabled","enableImages","legend","navigator","plotOptions","line","marker","radius","candlestick","lineColor","upColor","upLineColor","shadow","rangeSelector","Highcharts","Chart","addPlotLineX","addPlotLine","id","dashStyle","addPlotLineY","init","contract_id","transaction_id","Promise","resolve","reject","liveapi","send","then","proposal","underlying","undefined","shortcode","init_dialog","catch","err","console","error","handleError","message","$","growl","forget","echo_req","subscribe","updateIndicative","contract","updateState","drawChart","contract_has_finished","status","onContractFinished","updateStateSell","handleForwardStarting","manualReflow","sell_time","is_path_dependent","exit_tick_time","parseInt","is_sold_before_expiry","date_expiry","current_spot","current_spot_time","bid_price","entry_tick","toFixed","is_sold","exit_tick","sell_price","is_valid_to_sell","barrier","high_barrier","low_barrier","note","makeNote","sell","unit","cent","constract_is_forward_starting","is_forward_starting","fwd_starting","drawSparkline","drawSpots","drawXLines","drawBarriers","drawZones","drawZone","label","zone_idx","hasLabel","tick_count","drawSpot","series_spot","getMarkerSettings","update","drawXLine","line_time","drawEndTime","drawPurchaseTime","purchase_time","is_ended","sell_at_market_enabled","validation_error","is_expired","bid_prices","shift","html","initState","transWin","display_name","minWidth","minHeight","view","unbind","events","off","on_proposal_open_contract_cb","onclose","resize","rv","bind","sellAtMarket","price","buy_price","longcode","currency","state_confirm","sold_for","return_percent","balance","balance_after","$html","after","view_confirm","route","loading","added_labels","includes","h","container","setSize","hasUserSize","showLoading","hideLoading","is_settleable","is_sold_at_market","isLookback","Lookback","contract_type","lb_formula","formula","multiplier","formatPrice","setupChart","getContractData","onProposalOpenContract","on","is_different_stream","updateLiveChart","granularity","key","chartingRequestMap","keyFor","handleChartingRequestMap","on_tick_cb","on_candles_cb","clean_up_done","cleanUp","handleTick","handleCandle","req","makeChartingRequestMapRequest","register","symbol","style","tick","addTickToChart","addPoint","quote","data_key","ohlc","last","open_time","unregister","removeBarriers","addBarrierToChart","removePlotLine","duration","unix","makeGranularity","margin","makeTimeMargin","tick_history_request","makeTickHistoryRequest","onTickHistorySuccess","onTickHistoryError","start","contract_has_not_started","end","request","adjust_start_time","ticks_history","count","makeChartOptions"],"mappings":"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","file":"viewTransaction.js","sourcesContent":["﻿import $ from 'jquery';\nimport windows from 'windows/windows';\nimport liveapi from 'websockets/binary_websockets';\nimport chartingRequestMap from 'charts/chartingRequestMap';\nimport rv from 'common/rivetsExtra';\nimport moment from 'moment';\nimport 'common/util';\nimport * as ChartSettings from '../charts/chartSettings';\nimport Lookback from 'trade/lookback';\nrequire(['css!viewtransaction/viewTransaction.css']);\nrequire(['text!viewtransaction/viewTransaction.html']);\n\nconst open_dialogs = {};\nconst NOTE_TEXT = {\n  EXPIRED: 'This contract has expired'.i18n(),\n  MARKET_RATE: 'Note: Contract will be sold at the prevailing market price when the request is received by our servers. This price may differ from the indicated price.'.i18n(),\n  NO_RESALE: 'Resale of this contract is not offered'.i18n(),\n  FINISHED: 'This contract has expired'.i18n(),\n};\n\nlet market_data_disruption_win = null;\nconst showMarketDataDisruptionWindow = () => {\n   if (market_data_disruption_win) {\n      market_data_disruption_win.moveToTop();\n      return;\n   }\n   const market_disrupt_msg = 'There was a market data disruption during the contract period. For real-money accounts we will attempt to correct this and settle the contract properly, otherwise the contract will be cancelled and refunded. Virtual-money contracts will be cancelled and refunded.'.i18n();\n   const root = $('<div class=\"data-disruption-dialog\">' + market_disrupt_msg + '</div>');\n\n   market_data_disruption_win = windows.createBlankWindow(root, {\n      title: ' There was an error '.i18n(),\n      height: 200,\n      resizable:false,\n      collapsable:false,\n      minimizable: false,\n      maximizable: false,\n      destroy: () => {\n         market_data_disruption_win && market_data_disruption_win.dialog('destroy').remove();\n         market_data_disruption_win = null;\n      },\n      'data-authorized': 'true'\n   });\n\n   market_data_disruption_win.dialog('open');\n   window.dd = market_data_disruption_win;\n};\n\nconst countDecimals = (value) => { \n  if ((value % 1) != 0) \n      return value.toString().split(\".\")[1].length;  \n  return 0;\n};\n\nconst initChart = (root, state, options) => {\n   let data = [];\n   let type = '';\n   let display_decimals = 3;\n\n   if (options.history) {\n      type = 'line';\n      const { history } = options;\n      const { times, prices } = history;\n\n      for (let i = 0; i < times.length; ++i) {\n         data.push([times[i] * 1000, prices[i] * 1]);\n         display_decimals = Math.max(display_decimals, prices[i].toString().substring(prices[i].toString().indexOf('.') + 1).length);\n      }\n   }\n\n   if (options.candles) {\n      type = 'candlestick';\n      data = options.candles.map((c) => [c.epoch * 1000, c.open * 1, c.high * 1, c.low * 1, c.close * 1]);\n   }\n\n   const { title } = options;\n   const el = root.find('.transaction-chart')[0];\n   const CHART_LABELS = ChartSettings.getChartLabels(state.proposal_open_contract);\n   const { entry_tick_time, date_start } = state.proposal_open_contract;\n   const zone_start = entry_tick_time || date_start;\n\n   const chart_options = {\n      credits: { href: '#', text: '' },\n      chart: {\n         type: 'line',\n         renderTo: el,\n         backgroundColor: null, /* make background transparent */\n         width: 0,\n         height: 0,\n         marginLeft: 65,\n         marginRight:20\n      },\n      title: { text: '' },\n      subtitle: {\n        text: ChartSettings.getLabelEl(CHART_LABELS),\n        useHTML: true,\n      },\n      tooltip: {\n         useHTML: true,\n         formatter() {\n            const spot = addComma(this.y, display_decimals);\n            const spot_time = moment.utc(this.x).format('dddd, MMM D, HH:mm:ss');\n            return `<div class='tooltip-body'>${spot_time} GMT<br/>${this.series.name} ${spot}</div>`;\n        },\n      },\n      xAxis: {\n         type: 'datetime',\n         categories:null,\n         startOnTick: false,\n         endOnTick: false,\n         min: data.length ? data[0][0] : null,\n         max: data.length ? data[data.length - 1][0] : null,\n         labels: { overflow:\"justify\", format:\"{value:%H:%M:%S}\" },\n      },\n      yAxis: {\n        labels: {\n          align: 'left',\n          x: -65,\n          y: -2,\n          formatter() {\n            return addComma(this.value, display_decimals);\n          },\n        },\n         title: '',\n      },\n      series: [{\n         name: title,\n         data: data,\n         type: type,\n         zIndex: 10,\n         zoneAxis: 'x',\n         // zones are used to display color of the line\n         zones:[{\n             // make the line grey until it reaches entry time or zone_start time if entry spot time is not yet known\n             value: zone_start ? +zone_start * 1000 : '',\n             color: '#ccc',\n         }, {\n             // make the line default color until exit time is reached\n             color: '',\n         }, {\n             // make the line grey again after trade ended\n             color: '#ccc',\n         }],\n      }],\n      exporting: { enabled: false, enableImages: false},\n      legend: { enabled: false},\n      navigator: { enabled: true },\n      plotOptions: {\n         line: {\n            marker: { radius: 2 }\n         },\n         candlestick: {\n            lineColor: 'black',\n            color: 'red',\n            upColor: 'green',\n            upLineColor: 'black',\n            shadow: true\n         },\n      },\n      rangeSelector: { enabled: false },\n   };\n   const chart = new Highcharts.Chart(chart_options);\n\n   chart.addPlotLineX = (options) => {\n      chart.xAxis[0].addPlotLine({\n         value: options.value,\n         id: options.id || options.value,\n         color: options.color || '#e98024',\n         zIndex: 0,\n         width: options.width || 2,\n         dashStyle: options.dashStyle,\n      });\n   };\n\n   chart.addPlotLineY = (options) => {\n      chart.yAxis[0].addPlotLine({\n         id: options.id,\n         value: options.value,\n         color: options.color || 'green',\n         zIndex: 0,\n         width: 2,\n         dashStyle: options.dashStyle,\n      });\n   };\n   return el.chart = chart;\n};\n\nexport const init = (contract_id, transaction_id) => {\n   return new Promise((resolve, reject) => {\n      if (open_dialogs[transaction_id]) {\n         open_dialogs[transaction_id].moveToTop();\n         resolve();\n         return;\n      }\n      liveapi.send({proposal_open_contract: 1, contract_id})\n        .then((data) => {\n            const proposal = data.proposal_open_contract;\n            /* check for market data disruption error */\n            if (proposal.underlying === undefined && proposal.shortcode === undefined) {\n               showMarketDataDisruptionWindow(proposal);\n               return;\n            }\n            proposal.transaction_id = transaction_id;\n            init_dialog(proposal);\n            resolve();\n         })\n         .catch((err) => {\n            console.error(err);\n            reject(err);\n         });\n   });\n};\n\nconst handleError = (message) => {\n  $.growl.error({ message });\n  liveapi.proposal_open_contract.forget(data.echo_req.contract_id);\n  liveapi.proposal_open_contract.subscribe(data.echo_req.contract_id);\n};\n\nconst updateIndicative = (data, state) => {\n  const contract = data.proposal_open_contract;\n  updateState(contract, state);\n  drawChart(contract, state);\n\n  const contract_has_finished = contract.status !== 'open';\n  if (contract_has_finished) {\n    onContractFinished(state);\n    return;\n  }\n\n  updateStateSell();\n  handleForwardStarting();\n  state.chart.manualReflow();\n\n  function updateState(contract, state) {\n    const sell_time = contract.is_path_dependent && contract.status !== 'sold' ? contract.exit_tick_time : parseInt(contract.sell_time);\n\n    // note: cannot use spread operator - rivets.js 2-way data-binding breaks if new object\n    state.proposal_open_contract.is_sold_before_expiry = sell_time < contract.date_expiry;\n    state.proposal_open_contract.current_spot = contract.current_spot;\n    state.proposal_open_contract.current_spot_time = contract.current_spot_time;\n    state.proposal_open_contract.bid_price = contract.bid_price;\n    state.proposal_open_contract.entry_tick = countDecimals(contract.entry_tick) < 3 ? contract.entry_tick.toFixed(3) : contract.entry_tick;\n    state.proposal_open_contract.entry_tick_time = contract.entry_tick_time;\n    state.proposal_open_contract.status = contract.status;\n    state.proposal_open_contract.is_sold = contract.is_sold;\n    state.proposal_open_contract.exit_tick = countDecimals(contract.exit_tick) < 3 ? contract.exit_tick.toFixed(3) : contract.exit_tick;\n    state.proposal_open_contract.exit_tick_time = contract.exit_tick_time;\n    state.proposal_open_contract.date_expiry = contract.date_expiry;\n    state.proposal_open_contract.sell_price = contract.sell_price;\n    state.proposal_open_contract.is_valid_to_sell = contract.is_valid_to_sell;\n    state.proposal_open_contract.barrier = contract.barrier;\n    state.proposal_open_contract.high_barrier = contract.high_barrier;\n    state.proposal_open_contract.low_barrier = contract.low_barrier;\n\n    state.note = makeNote(contract);\n  }\n\n  function updateStateSell() {\n    if (contract.bid_price) {\n      state.sell.bid_price.value = contract.bid_price;\n      [state.sell.bid_price.unit, state.sell.bid_price.cent] = contract.bid_price.toString().split(/[\\.,]+/);\n    }\n  }\n\n  function handleForwardStarting() {\n    const constract_is_forward_starting = contract.is_forward_starting && +contract.date_start > +contract.current_spot_time;\n    if (constract_is_forward_starting) {\n      state.fwd_starting = '* Contract has not started yet'.i18n();\n      return;\n    }\n    state.fwd_starting = '';\n  }\n};\n\nfunction drawChart(contract, state) {\n  drawSparkline(contract, state);\n\n  const { chart } = state.chart;\n  if (!chart) return;\n\n  drawSpots(contract, state, chart);\n  drawXLines(contract, state, chart);\n  drawBarriers(contract, state);\n  drawZones(contract, state, chart);\n}\n\nfunction drawZones(contract, state, chart) {\n  const { entry_tick_time, exit_tick_time, date_expiry, sell_time } = contract;\n  const { is_sold_before_expiry } = state.proposal_open_contract;\n\n  drawZone({ spot_time: entry_tick_time, label: 'entry_zone', zone_idx: 0 });\n\n  if (is_sold_before_expiry) {\n    drawZone({ spot_time: exit_tick_time || sell_time, label: 'exit_zone', zone_idx: 1 });\n  }\n  drawZone({ spot_time: exit_tick_time || date_expiry, label: 'exit_zone', zone_idx: 1 });\n\n  function drawZone({spot_time, label, zone_idx}) {\n    if (!spot_time || state.chart.hasLabel(label)) return;\n\n    chart.series[0].zones[zone_idx].value = (+spot_time * 1000);\n  }\n}\n\nfunction drawSpots(contract, state, chart) {\n  const { entry_tick_time, exit_tick_time, tick_count, is_path_dependent } = contract;\n  const { is_sold_before_expiry } = state.proposal_open_contract;\n\n  if (tick_count) return; // tick contracts = chart should not have entry/exit spots\n\n  if (entry_tick_time) {\n    drawSpot({ spot_time: entry_tick_time, label: 'entry_tick_time', color: 'white' });\n  }\n\n  if (is_path_dependent && exit_tick_time) {\n    drawSpot({ spot_time: exit_tick_time, label: 'exit_tick_time', color: 'orange' });\n  }\n\n  if (!is_sold_before_expiry) drawSpot({ spot_time: exit_tick_time, label: 'exit_tick_time', color: 'orange' });\n\n  function drawSpot({ spot_time, label, color }) {\n    if (!spot_time || state.chart.hasLabel(label)) return;\n\n    const series_spot = chart.series[0].data.find((marker) => +marker.x === (+spot_time * 1000));\n    if (!series_spot) return;\n\n    const marker = ChartSettings.getMarkerSettings(color);\n    series_spot.update({ marker });\n  }\n}\n\nfunction drawXLines(contract, state, chart) {\n  const { entry_tick_time, exit_tick_time, date_start, date_expiry, tick_count, sell_time } = contract;\n\n  if (tick_count) { // only for tick contracts\n    drawXLine({ line_time: entry_tick_time, label: 'start_time' });\n    drawXLine({ line_time: exit_tick_time, label: 'end_time', dashStyle: 'Dash' });\n    return;\n  }\n\n  drawXLine({ line_time: date_start, label: 'start_time' });\n  drawEndTime(contract);\n  drawPurchaseTime(contract);\n\n  function drawXLine({ line_time, label, dashStyle, color }) {\n    if (!line_time || state.chart.hasLabel(label)) return false;\n\n    chart.addPlotLineX({ value: +line_time * 1000, dashStyle, color});\n  }\n\n  function drawEndTime({ is_path_dependent }) {\n    const { is_sold_before_expiry } = state.proposal_open_contract;\n\n    if (is_path_dependent && exit_tick_time && is_sold_before_expiry) {\n      drawXLine({ line_time: exit_tick_time, label: 'end_time', dashStyle: 'Dash' });\n    }\n\n    if (is_sold_before_expiry) drawXLine({ line_time: sell_time, label: 'end_time', dashStyle: 'Dash' });\n    if (!is_path_dependent) drawXLine({ line_time: date_expiry, label: 'end_time', dashStyle: 'Dash' });\n  }\n\n  function drawPurchaseTime({ purchase_time }) {\n    if (date_start > purchase_time) {\n      drawXLine({ line_time: purchase_time, label: 'purchase_time', color:'#7cb5ec' });\n    }\n  }\n}\n\nconst onContractFinished = (state) => {\n  state.proposal_open_contract.is_ended = true;\n  state.sell.sell_at_market_enabled = false;\n};\n\nconst makeNote = (contract) => {\n    if (contract.validation_error) return contract.validation_error;\n    if (contract.status !== 'open') return NOTE_TEXT.FINISHED;\n    if (contract.is_expired || contract.is_sold) return NOTE_TEXT.EXPIRED;\n    if (contract.is_valid_to_sell) return NOTE_TEXT.MARKET_RATE;\n    if (!contract.is_valid_to_sell) return NOTE_TEXT.NO_RESALE;\n};\n\nconst drawSparkline = (contract, state) => {\n  if (state.sell.bid_prices.length > 40) state.sell.bid_prices.shift();\n\n  state.sell.bid_prices.push(contract.bid_price);\n};\n\nconst init_dialog = (proposal) => {\n   require(['text!viewtransaction/viewTransaction.html'], (html) => {\n      const root = $(html).i18n();\n      const state = initState(proposal, root);\n\n      const transWin = windows.createBlankWindow(root, {\n         title: proposal.display_name + ' (' + proposal.transaction_id + ')',\n         width: 700,\n         minWidth: 630,\n         minHeight: 480,\n         height: 480,\n         destroy: () => {},\n         close: function() {\n            view && view.unbind();\n            liveapi.proposal_open_contract.forget(proposal.contract_id);\n            liveapi.events.off('proposal_open_contract', on_proposal_open_contract_cb);\n            for(let i = 0; i < state.onclose.length; ++i)\n               state.onclose[i]();\n            $(this).dialog('destroy').remove();\n            open_dialogs[proposal.transaction_id] = undefined;\n         },\n         open: () => {\n          liveapi.proposal_open_contract.forget(proposal.contract_id);\n         },\n         resize: () => {\n            state.chart.manualReflow();\n         },\n         'data-authorized': 'true'\n      });\n\n      transWin.dialog('open');\n      const view = rv.bind(root[0], state);\n      open_dialogs[proposal.transaction_id] = transWin;\n   });\n};\n\nconst sellAtMarket = (state, root) => {\n   state.sell.sell_at_market_enabled = false;\n   require(['text!viewtransaction/viewTransactionConfirm.html', 'css!viewtransaction/viewTransactionConfirm.css']);\n   liveapi.send({ sell: state.proposal_open_contract.contract_id, price: 0 })\n      .then((data) => {\n         state.proposal_open_contract.is_sold_before_expiry = true;\n         const { sell } = data;\n         require(['text!viewtransaction/viewTransactionConfirm.html', 'css!viewtransaction/viewTransactionConfirm.css'],\n            (html) => {\n               const { buy_price, longcode, currency } = state.proposal_open_contract;\n               const state_confirm = {\n                  longcode,\n                  buy_price,\n                  sell_price: sell.sold_for,\n                  return_percent: (100 * (sell.sold_for - buy_price) / buy_price).toFixed(2) + '%',\n                  transaction_id: sell.transaction_id,\n                  balance: sell.balance_after,\n                  currency,\n               };\n               const $html = $(html).i18n();\n               root.after($html);\n               const view_confirm = rv.bind($html[0], state_confirm);\n               state.onclose.push(() => {\n                  view_confirm && view_confirm.unbind();\n               });\n            });\n      })\n      .catch((err) => {\n         $.growl.error({ message: err.message });\n         console.error(err);\n      });\n};\n\nconst initState = (proposal, root) => {\n   const sell_time = proposal.is_path_dependent && proposal.status !== 'sold' ? proposal.exit_tick_time : parseInt(proposal.sell_time);\n\n   const state = {\n      route: {\n         value: 'table',\n         update: (value) => { state.route.value = value; },\n      },\n      note: makeNote(proposal),\n      chart: {\n         chart: null, /* highchart object */\n         loading: 'Loading ' + proposal.display_name + ' ...',\n         added_labels: [],\n         hasLabel: (label) => {\n          if (state.chart.added_labels.includes(label)) return true;\n\n          state.chart.added_labels.push(label);\n          return false;\n         },\n         type: 'ticks', // could be 'tick' or 'ohlc'\n         manualReflow: () => {\n          if (!state.chart.chart) return;\n\n          const h = -1 * (root.find('.longcode').height() + root.find('.tabs').height() + root.find('.footer').height()) - 16;\n          const container = root;\n          const width = container.width() - 10;\n          const height = container.height();\n\n          state.chart.chart.setSize(width, height + h , false);\n          state.chart.chart.hasUserSize = null;\n          if (state.chart.chart.series[0] && state.chart.chart.series[0].data.length === 0) {\n            state.chart.chart.showLoading();\n            return;\n          }\n          state.chart.chart.hideLoading();\n       },\n      },\n      proposal_open_contract: {\n        ...proposal,\n        currency: (proposal.currency ||  'USD') + ' ',\n        is_ended: proposal.is_settleable || proposal.is_sold || proposal.status !== 'open',\n        is_sold_at_market: false,\n        is_sold_before_expiry: sell_time < proposal.date_expiry,\n        isLookback: Lookback.isLookback(proposal.contract_type),\n        lb_formula: Lookback.formula(proposal.contract_type, proposal.multiplier && formatPrice(proposal.multiplier, proposal.currency ||  'USD')),\n      },\n      sell: {\n         bid_prices: [],\n         bid_price: {\n            unit: undefined,\n            cent: undefined,\n            value: undefined,\n         },\n         sell: () => sellAtMarket(state, root),\n         sell_at_market_enabled: true,\n      },\n      onclose: [], /* cleanup callback array when dialog is closed */\n   };\n   setupChart(state, root);\n   return state;\n};\n\nlet on_proposal_open_contract_cb;\nfunction getContractData(state, proposal) {\n  on_proposal_open_contract_cb = onProposalOpenContract;\n\n  liveapi.proposal_open_contract.subscribe(proposal.contract_id)\n  liveapi.events.on('proposal_open_contract', on_proposal_open_contract_cb);\n\n  function onProposalOpenContract(data) {\n    const is_different_stream = +data.proposal_open_contract.contract_id !== +state.proposal_open_contract.contract_id;\n    if (is_different_stream) return;\n\n    if (data.error) {\n      handleError(data.error.message);\n      return;\n    }\n    updateIndicative(data, state);\n  }\n}\n\nconst updateLiveChart = (state, granularity) => {\n  const key = chartingRequestMap.keyFor(state.proposal_open_contract.underlying, granularity);\n  handleChartingRequestMap(key);\n\n  let on_tick_cb = undefined;\n  let on_candles_cb = undefined;\n  let clean_up_done = false;\n  state.onclose.push(cleanUp);\n\n  if (granularity === 0) {\n    handleTick();\n    return;\n  }\n  handleCandle();\n\n  /* don't register if already someone else has registered for this symbol */\n  function handleChartingRequestMap() {\n    if(!chartingRequestMap[key]){\n      const req = makeChartingRequestMapRequest(granularity, state.proposal_open_contract.underlying);\n      chartingRequestMap.register(req)\n          .catch((err) => {\n            $.growl.error({ message: err.message });\n            console.error(err);\n          });\n    } else {\n      chartingRequestMap.subscribe(key);\n    }\n  }\n\n  function makeChartingRequestMapRequest(granularity, symbol) {\n    return ({\n      symbol,\n      subscribe: 1,\n      granularity,\n      style: granularity === 0 ? 'ticks' : 'candles',\n    });\n  }\n\n  function handleTick() {\n    on_tick_cb = liveapi.events.on('tick', (data) => {\n        if (!data.tick || data.tick.symbol !== state.proposal_open_contract.underlying) return;\n\n        const { chart } = state.chart;\n        const { status, is_sold, exit_tick, exit_tick_time } = state.proposal_open_contract;\n        const { tick } = data;\n\n        const contract_has_finished = is_sold || status !== 'open' || exit_tick || exit_tick_time;\n        if (contract_has_finished) {\n          cleanUp();\n          return;\n        };\n\n        addTickToChart(chart, tick);\n    });\n\n    function addTickToChart(chart, tick) {\n      if (!chart) return;\n      chart.series[0].addPoint([tick.epoch * 1000, tick.quote * 1, 'gray']);\n    }\n  }\n\n  function handleCandle() {\n    on_candles_cb = liveapi.events.on('ohlc', (data) => {\n      const data_key = chartingRequestMap.keyFor(data.ohlc.symbol, data.ohlc.granularity);\n      if (key !== data_key) return;\n\n      const { chart } = state.chart;\n      if (!chart) return;\n\n      const series = chart.series[0];\n      const last = series.data[series.data.length - 1];\n\n      const c = data.ohlc;\n      const ohlc = [c.open_time * 1000, c.open * 1, c.high * 1, c.low * 1, c.close * 1];\n\n      if (last.x !== ohlc[0]) {\n          series.addPoint(ohlc, true, true);\n      } else {\n        last.update(ohlc,true);\n      }\n      const { status, is_sold, exit_tick, exit_tick_time, date_expiry} = state.proposal_open_contract;\n      const contract_has_finished = (c.epoch * 1 > date_expiry * 1) || status !== 'open' || exit_tick || exit_tick_time;\n\n      if (contract_has_finished) cleanUp();\n    });\n  }\n\n  function cleanUp() {\n    if (clean_up_done) return;\n    clean_up_done = true;\n\n    chartingRequestMap.unregister(key);\n    on_tick_cb && liveapi.events.off('tick', on_tick_cb);\n    on_candles_cb && liveapi.events.off('candles', on_candles_cb);\n  }\n};\n\nconst drawBarriers = (contract, state) => {\n  const { chart } = state.chart;\n  const { barrier, high_barrier, low_barrier, tick_count } = state.proposal_open_contract;\n\n  removeBarriers(barrier, high_barrier, low_barrier);\n  addBarrierToChart(barrier, high_barrier, low_barrier);\n\n  function addBarrierToChart(barrier, high_barrier, low_barrier) {\n    const dashStyle = tick_count ? '' : 'dot';\n\n    if (barrier)  chart.addPlotLineY({ id: 'barrier', value: barrier, dashStyle })\n    if (high_barrier) chart.addPlotLineY({ id: 'high_barrier', value: high_barrier, dashStyle })\n    if (low_barrier) chart.addPlotLineY({ id: 'low_barrier', value: low_barrier, dashStyle })\n  }\n\n  function removeBarriers(barrier, high_barrier, low_barrier) {\n    if (barrier) chart.yAxis[0].removePlotLine('barrier');\n    if (high_barrier) chart.yAxis[0].removePlotLine('high_barrier');\n    if (low_barrier) chart.yAxis[0].removePlotLine('low_barrier');\n  }\n}\n\nconst setupChart = (state, root) => {\n  const duration = Math.min(+state.proposal_open_contract.date_expiry, moment.utc().unix()) - (state.proposal_open_contract.purchase_time || state.proposal_open_contract.date_start);\n  const granularity = makeGranularity(duration);\n  const margin = makeTimeMargin(duration, granularity);\n  const tick_history_request = makeTickHistoryRequest(granularity, margin);\n\n  // setup tick/candle stream for chart\n  if (!state.proposal_open_contract.is_ended) updateLiveChart(state, granularity);\n\n  liveapi.send(tick_history_request)\n    .then((data) => {\n      onTickHistorySuccess(data);\n      getContractData(state, state.proposal_open_contract);\n    }).catch((err) => {\n      onTickHistoryError(err);\n  });\n\n  function makeGranularity(duration) {\n    let granularity = 0;\n\n    if (duration <= 60 * 60) { granularity = 0; } // 1 hour\n    else if (duration <= 2 * 60 * 60) { granularity = 60; } // 2 hours\n    else if (duration <= 6 * 60 * 60) { granularity = 120; } // 6 hours\n    else if (duration <= 24 * 60 * 60) { granularity = 300; } // 1 day\n    else { granularity = 3600 } // more than 1 day\n    return granularity;\n  }\n\n  function makeTimeMargin(duration, granularity) {\n    let margin = 0;\n    margin = (granularity === 0) ? Math.max(3, 30 * duration / (60 * 60) | 0) : 3 * granularity;\n    return margin;\n  }\n\n  function makeTickHistoryRequest(granularity, margin) {\n    const { date_start, current_spot_time, purchase_time, exit_tick_time } = state.proposal_open_contract;\n    const is_forward_starting = +date_start > +purchase_time;\n    let start;\n\n    if (is_forward_starting) {\n      start = purchase_time;\n    } else {\n      const contract_has_not_started = (+date_start > +current_spot_time) || +exit_tick_time < +date_start;\n      start = contract_has_not_started ? +purchase_time : (+date_start || +purchase_time);\n    }\n    const end = ((start > exit_tick_time) || !exit_tick_time) ? 'latest' : +exit_tick_time + margin;\n\n    const request = {\n      adjust_start_time: 1,\n      ticks_history: state.proposal_open_contract.underlying,\n      start: start - margin, /* load around 2 more ticks before start */\n      end,\n      style: 'ticks',\n      count: 4999, /* maximum number of ticks possible */\n    };\n\n    if (granularity !== 0) {\n      request.granularity = granularity;\n      request.style = 'candles';\n      state.chart.type = 'candles';\n    }\n    return request;\n  }\n\n\n  function onTickHistorySuccess(data) {\n    state.chart.loading = '';\n    const chart_options = makeChartOptions(data, state.proposal_open_contract.display_name);\n    const chart = initChart(root, state, chart_options);\n    state.chart.chart = chart;\n    state.chart.manualReflow();\n\n    function makeChartOptions(data, title) {\n      return ({ title, ...data });\n    }\n  }\n\n  function onTickHistoryError(err) {\n    state.chart.loading = err.message;\n    console.error(err);\n  }\n};\n\nexport default  { init };\n"]}