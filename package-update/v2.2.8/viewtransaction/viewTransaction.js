define(["exports","jquery","windows/windows","websockets/binary_websockets","charts/chartingRequestMap","common/rivetsExtra","moment","../charts/chartSettings","trade/lookback","common/util"],function(t,e,r,a,o,i,n,c,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.init=void 0;var p=u(e),s=u(r),m=u(a),v=u(o),d=u(i),y=u(n),g=function(t){{if(t&&t.__esModule)return t;var e={};if(null!=t)for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e.default=t,e}}(c),_=u(l);function u(t){return t&&t.__esModule?t:{default:t}}var f=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(t[a]=r[a])}return t},h=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var r=[],a=!0,o=!1,i=void 0;try{for(var n,c=t[Symbol.iterator]();!(a=(n=c.next()).done)&&(r.push(n.value),!e||r.length!==e);a=!0);}catch(t){o=!0,i=t}finally{try{!a&&c.return&&c.return()}finally{if(o)throw i}}return r}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")};require(["css!viewtransaction/viewTransaction.css"]),require(["text!viewtransaction/viewTransaction.html"]);var b={},x={EXPIRED:"This contract has expired".i18n(),MARKET_RATE:"Note: Contract will be sold at the prevailing market price when the request is received by our servers. This price may differ from the indicated price.".i18n(),NO_RESALE:"Resale of this contract is not offered".i18n(),FINISHED:"This contract has expired".i18n()},w=null,k=t.init=function(t,a){return new Promise(function(r,e){if(b[a])return b[a].moveToTop(),void r();m.default.send({proposal_open_contract:1,contract_id:t}).then(function(t){var e=t.proposal_open_contract;void 0!==e.underlying||void 0!==e.shortcode?(e.transaction_id=a,P(e),r()):function(){if(w)w.moveToTop();else{var t="There was a market data disruption during the contract period. For real-money accounts we will attempt to correct this and settle the contract properly, otherwise the contract will be cancelled and refunded. Virtual-money contracts will be cancelled and refunded.".i18n(),e=(0,p.default)('<div class="data-disruption-dialog">'+t+"</div>");(w=s.default.createBlankWindow(e,{title:" There was an error ".i18n(),height:200,resizable:!1,collapsable:!1,minimizable:!1,maximizable:!1,destroy:function(){w&&w.dialog("destroy").remove(),w=null},"data-authorized":"true"})).dialog("open"),window.dd=w}}()}).catch(function(t){e(t)})})},S=function(t,r){var e,a,o,i=t.proposal_open_contract;a=r,o=(e=i).is_path_dependent&&"sold"!==e.status?e.exit_tick_time:parseInt(e.sell_time),a.proposal_open_contract.is_sold_before_expiry=o<e.date_expiry,a.proposal_open_contract.current_spot=e.current_spot,a.proposal_open_contract.current_spot_time=e.current_spot_time,a.proposal_open_contract.bid_price=e.bid_price,a.proposal_open_contract.entry_tick=e.entry_tick,a.proposal_open_contract.entry_tick_time=e.entry_tick_time,a.proposal_open_contract.status=e.status,a.proposal_open_contract.is_sold=e.is_sold,a.proposal_open_contract.exit_tick=e.exit_tick,a.proposal_open_contract.exit_tick_time=e.exit_tick_time,a.proposal_open_contract.date_expiry=e.date_expiry,a.proposal_open_contract.sell_price=e.sell_price,a.proposal_open_contract.is_valid_to_sell=e.is_valid_to_sell,a.proposal_open_contract.barrier=e.barrier,a.proposal_open_contract.high_barrier=e.high_barrier,a.proposal_open_contract.low_barrier=e.low_barrier,a.note=T(e),function(t,e){z(t,e);var r=e.chart.chart;if(!r)return;(function(t,n,c){var e=t.entry_tick_time,r=t.exit_tick_time,a=t.tick_count,o=t.is_path_dependent,i=n.proposal_open_contract.is_sold_before_expiry;if(a)return;e&&l({spot_time:e,label:"entry_tick_time",color:"white"});o&&r&&l({spot_time:r,label:"exit_tick_time",color:"orange"});i||l({spot_time:r,label:"exit_tick_time",color:"orange"});function l(t){var e=t.spot_time,r=t.label,a=t.color;if(e&&!n.chart.hasLabel(r)){var o=c.series[0].data.find(function(t){return+t.x==1e3*+e});if(o){var i=g.getMarkerSettings(a);o.update({marker:i})}}}})(t,e,r),function(t,i,n){var e=t.entry_tick_time,a=t.exit_tick_time,r=t.date_start,o=t.date_expiry,c=t.tick_count,l=t.sell_time;if(c)return s({line_time:e,label:"start_time"}),s({line_time:a,label:"end_time",dashStyle:"Dash"});function s(t){var e=t.line_time,r=t.label,a=t.dashStyle,o=t.color;if(!e||i.chart.hasLabel(r))return!1;n.addPlotLineX({value:1e3*+e,dashStyle:a,color:o})}s({line_time:r,label:"start_time"}),function(t){var e=t.is_path_dependent,r=i.proposal_open_contract.is_sold_before_expiry;e&&a&&r&&s({line_time:a,label:"end_time",dashStyle:"Dash"});r&&s({line_time:l,label:"end_time",dashStyle:"Dash"});e||s({line_time:o,label:"end_time",dashStyle:"Dash"})}(t),_=t,d=_.purchase_time,d<r&&s({line_time:d,label:"purchase_time",color:"#7cb5ec"});var _,d}(t,e,r),R(t,e),function(t,o,i){var e=t.entry_tick_time,r=t.exit_tick_time,a=t.date_expiry,n=t.sell_time,c=o.proposal_open_contract.is_sold_before_expiry;l({spot_time:e,label:"entry_zone",zone_idx:0}),c&&l({spot_time:r||n,label:"exit_zone",zone_idx:1});function l(t){var e=t.spot_time,r=t.label,a=t.zone_idx;e&&!o.chart.hasLabel(r)&&(i.series[0].zones[a].value=1e3*+e)}l({spot_time:r||a,label:"exit_zone",zone_idx:1})}(t,e,r)}(i,r),"open"!==i.status?L(r):(!function(){if(i.bid_price){r.sell.bid_price.value=i.bid_price;var t=i.bid_price.toString().split(/[\.,]+/),e=h(t,2);r.sell.bid_price.unit=e[0],r.sell.bid_price.cent=e[1]}}(),function(){if(i.is_forward_starting&&+i.date_start>+i.current_spot_time)return r.fwd_starting="* Contract has not started yet".i18n();r.fwd_starting=""}(),r.chart.manualReflow())};var L=function(t){t.proposal_open_contract.is_ended=!0,t.sell.sell_at_market_enabled=!1},T=function(t){return t.validation_error?t.validation_error:"open"!==t.status?x.FINISHED:t.is_expired||t.is_sold?x.EXPIRED:t.is_valid_to_sell?x.MARKET_RATE:t.is_valid_to_sell?void 0:x.NO_RESALE},z=function(t,e){40<e.sell.bid_prices.length&&e.sell.bid_prices.shift(),e.sell.bid_prices.push(t.bid_price)},P=function(i){require(["text!viewtransaction/viewTransaction.html"],function(t){var e=(0,p.default)(t).i18n(),r=E(i,e),a=s.default.createBlankWindow(e,{title:i.display_name+" ("+i.transaction_id+")",width:700,minWidth:630,minHeight:480,height:480,destroy:function(){},close:function(){o&&o.unbind(),m.default.proposal_open_contract.forget(i.contract_id),m.default.events.off("proposal_open_contract",M);for(var t=0;t<r.onclose.length;++t)r.onclose[t]();(0,p.default)(this).dialog("destroy").remove(),b[i.transaction_id]=void 0},open:function(){m.default.proposal_open_contract.forget(i.contract_id)},resize:function(){r.chart.manualReflow()},"data-authorized":"true"});a.dialog("open");var o=d.default.bind(e[0],r);b[i.transaction_id]=a})},E=function(t,o){var e=t.is_path_dependent&&"sold"!==t.status?t.exit_tick_time:parseInt(t.sell_time),i={route:{value:"table",update:function(t){i.route.value=t}},note:T(t),chart:{chart:null,loading:"Loading "+t.display_name+" ...",added_labels:[],hasLabel:function(t){return!!i.chart.added_labels.includes(t)||(i.chart.added_labels.push(t),!1)},type:"ticks",manualReflow:function(){if(i.chart.chart){var t=-1*(o.find(".longcode").height()+o.find(".tabs").height()+o.find(".footer").height())-16,e=o,r=e.width()-10,a=e.height();i.chart.chart.setSize(r,a+t,!1),i.chart.chart.hasUserSize=null,i.chart.chart.series[0]&&0===i.chart.chart.series[0].data.length?i.chart.chart.showLoading():i.chart.chart.hideLoading()}}},proposal_open_contract:f({},t,{currency:(t.currency||"USD")+" ",is_ended:t.is_settleable||t.is_sold||"open"!==t.status,is_sold_at_market:!1,is_sold_before_expiry:e<t.date_expiry,isLookback:_.default.isLookback(t.contract_type),lb_formula:_.default.formula(t.contract_type,t.multiplier&&formatPrice(t.multiplier,t.currency||"USD"))}),sell:{bid_prices:[],bid_price:{unit:void 0,cent:void 0,value:void 0},sell:function(){return _=o,(s=i).sell.sell_at_market_enabled=!1,require(["text!viewtransaction/viewTransactionConfirm.html","css!viewtransaction/viewTransactionConfirm.css"]),void m.default.send({sell:s.proposal_open_contract.contract_id,price:0}).then(function(t){s.proposal_open_contract.is_sold_before_expiry=!0;var l=t.sell;require(["text!viewtransaction/viewTransactionConfirm.html","css!viewtransaction/viewTransactionConfirm.css"],function(t){var e=s.proposal_open_contract,r=e.buy_price,a=e.longcode,o=e.currency,i={longcode:a,buy_price:r,sell_price:l.sold_for,return_percent:(100*(l.sold_for-r)/r).toFixed(2)+"%",transaction_id:l.transaction_id,balance:l.balance_after,currency:o},n=(0,p.default)(t).i18n();_.after(n);var c=d.default.bind(n[0],i);s.onclose.push(function(){c&&c.unbind()})})}).catch(function(t){p.default.growl.error({message:t.message})});var s,_},sell_at_market_enabled:!0},onclose:[]};return C(i,o),i},M=void 0;function A(r,t){M=function(t){if(+t.proposal_open_contract.contract_id!=+r.proposal_open_contract.contract_id)return;if(t.error)return e=t.error.message,p.default.growl.error({message:e}),m.default.proposal_open_contract.forget(data.echo_req.contract_id),void m.default.proposal_open_contract.subscribe(data.echo_req.contract_id);var e;S(t,r)},m.default.proposal_open_contract.subscribe(t.contract_id),m.default.events.on("proposal_open_contract",M)}var R=function(t,e){var o=e.chart.chart,r=e.proposal_open_contract,a=r.barrier,i=r.high_barrier,n=r.low_barrier,c=r.tick_count;!function(t,e,r){t&&o.yAxis[0].removePlotLine("barrier");e&&o.yAxis[0].removePlotLine("high_barrier");r&&o.yAxis[0].removePlotLine("low_barrier")}(a,i,n),function(t,e,r){var a=c?"":"dot";t&&o.addPlotLineY({id:"barrier",value:t,dashStyle:a});e&&o.addPlotLineY({id:"high_barrier",value:e,dashStyle:a});r&&o.addPlotLineY({id:"low_barrier",value:r,dashStyle:a})}(a,i,n)},C=function(d,i){var t,e,r=Math.min(+d.proposal_open_contract.date_expiry,y.default.utc().unix())-(d.proposal_open_contract.purchase_time||d.proposal_open_contract.date_start),a=function(t){var e=0;e=t<=3600?0:t<=7200?60:t<=21600?120:t<=86400?300:3600;return e}(r),o=function(t,e){var r=d.proposal_open_contract,a=r.date_start,o=r.current_spot_time,i=r.purchase_time,n=r.exit_tick_time,c=void 0;if(+i<+a)c=i;else{var l=+o<+a||+n<+a;c=l?+i:+a||+i}var s=n<c||!n?"latest":+n+e,_={adjust_start_time:1,ticks_history:d.proposal_open_contract.underlying,start:c-e,end:s,style:"ticks",count:4999};0!==t&&(_.granularity=t,_.style="candles",d.chart.type="candles");return _}(a,(t=r,0===(e=a)?Math.max(3,30*t/3600|0):3*e));d.proposal_open_contract.is_ended||function(u,r){var f=v.default.keyFor(u.proposal_open_contract.underlying,r);!function(){if(v.default[f])v.default.subscribe(f);else{var t=(e=r,{symbol:u.proposal_open_contract.underlying,subscribe:1,granularity:e,style:0===e?"ticks":"candles"});v.default.register(t).catch(function(t){p.default.growl.error({message:t.message})})}var e}();var t=void 0,e=void 0,a=!1;function h(){a||(a=!0,v.default.unregister(f),t&&m.default.events.off("tick",t),e&&m.default.events.off("candles",e))}u.onclose.push(h),0!==r?e=m.default.events.on("ohlc",function(t){var e=v.default.keyFor(t.ohlc.symbol,t.ohlc.granularity);if(f===e){var r=u.chart.chart;if(r){var a=r.series[0],o=a.data[a.data.length-1],i=t.ohlc,n=[1e3*i.open_time,1*i.open,1*i.high,1*i.low,1*i.close];o.x!==n[0]?a.addPoint(n,!0,!0):o.update(n,!0);var c=u.proposal_open_contract,l=c.status,s=(c.is_sold,c.exit_tick),_=c.exit_tick_time,d=c.date_expiry,p=1*i.epoch>1*d||"open"!==l||s||_;p&&h()}}}):t=m.default.events.on("tick",function(t){if(t.tick&&t.tick.symbol===u.proposal_open_contract.underlying){var e=u.chart.chart,r=u.proposal_open_contract,a=r.status,o=r.is_sold,i=r.exit_tick,n=r.exit_tick_time,c=t.tick,l=o||"open"!==a||i||n;l?h():(_=c,(s=e)&&s.series[0].addPoint([1e3*_.epoch,1*_.quote,"gray"]))}var s,_})}(d,a),m.default.send(o).then(function(t){!function(t){d.chart.loading="";var e=(a=t,o=d.proposal_open_contract.display_name,f({title:o},a)),r=function(t,e,r){var a=[],o="",i=3;if(r.history){o="line";for(var n=r.history,c=n.times,l=n.prices,s=0;s<c.length;++s)a.push([1e3*c[s],1*l[s]]),i=Math.max(i,l[s].toString().substring(l[s].toString().indexOf(".")+1).length)}r.candles&&(o="candlestick",a=r.candles.map(function(t){return[1e3*t.epoch,1*t.open,1*t.high,1*t.low,1*t.close]}));var _=r.title,d=t.find(".transaction-chart")[0],p=g.getChartLabels(e.proposal_open_contract),u=e.proposal_open_contract,f=u.entry_tick_time,h=u.date_start,m=f||h,v={credits:{href:"#",text:""},chart:{type:"line",renderTo:d,backgroundColor:null,width:0,height:0,marginLeft:65,marginRight:20},title:{text:""},subtitle:{text:g.getLabelEl(p),useHTML:!0},tooltip:{useHTML:!0,formatter:function(){var t=addComma(this.y,i);return"<div class='tooltip-body'>"+y.default.utc(this.x).format("dddd, MMM D, HH:mm:ss")+" GMT<br/>"+this.series.name+" "+t+"</div>"}},xAxis:{type:"datetime",categories:null,startOnTick:!1,endOnTick:!1,min:a.length?a[0][0]:null,max:a.length?a[a.length-1][0]:null,labels:{overflow:"justify",format:"{value:%H:%M:%S}"}},yAxis:{labels:{align:"left",x:-65,y:-2,formatter:function(){return addComma(this.value,i)}},title:""},series:[{name:_,data:a,type:o,zIndex:10,zoneAxis:"x",zones:[{value:m?1e3*+m:"",color:"#ccc"},{color:""},{color:"#ccc"}]}],exporting:{enabled:!1,enableImages:!1},legend:{enabled:!1},navigator:{enabled:!0},plotOptions:{line:{marker:{radius:2}},candlestick:{lineColor:"black",color:"red",upColor:"green",upLineColor:"black",shadow:!0}},rangeSelector:{enabled:!1}},b=new Highcharts.Chart(v);return b.addPlotLineX=function(t){b.xAxis[0].addPlotLine({value:t.value,id:t.id||t.value,color:t.color||"#e98024",zIndex:0,width:t.width||2,dashStyle:t.dashStyle})},b.addPlotLineY=function(t){b.yAxis[0].addPlotLine({id:t.id,value:t.value,color:t.color||"green",zIndex:0,width:2,dashStyle:t.dashStyle})},d.chart=b}(i,d,e);var a,o;d.chart.chart=r,d.chart.manualReflow()}(t),A(d,d.proposal_open_contract)}).catch(function(t){var e;e=t,d.chart.loading=e.message})};t.default={init:k}});